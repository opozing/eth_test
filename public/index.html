<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>

    <h1>App Node</h1>


    <script>

        // console.log(parseInt("0xde0b6b3a7640000"));

        const LIMIT = 10;
        const AllData = [];
        const Users = [];
        const Sum = [];

        getLastBlock();

        async function getLastBlock()
        {
            const res = await fetch('https://api.etherscan.io/api?module=proxy&action=eth_blockNumber');
            const Data = await res.json();

            console.log(Data);

            let blockNumber = parseInt(Data.result);

            console.log(blockNumber);

            if(isNaN(blockNumber))
            {
                getLastBlock();
                return;
            }
                

            recurcyBlock(blockNumber, blockNumber - LIMIT);
        }

        async function recurcyBlock(blockNumber, end)
        {
            console.log(blockNumber, end);

            if(blockNumber == end)
            {
                calcSum();
                return;
            }

            const Transactions = await getTransactions(blockNumber);

            if(Transactions != undefined)
                AllData.push(...Transactions);

            console.log(AllData);

            blockNumber--;

            recurcyBlock(blockNumber, end);
        }


        async function getTransactions(blockNumber)
        {
            // console.log(blockNumber.toString(16))

            const res = await fetch(`https://api.etherscan.io/api?module=proxy&action=eth_getBlockByNumber&tag=0x${blockNumber.toString(16)}&boolean=true&apikey=CVP9SCG9KAKHIPEP4RG22D43JC1TIVPUIJ`);

            const Data = await res.json();

            // console.log(Data.result.transactions)
            
            return  Data.result.transactions;
        }

        function calcSum()
        {
            AllData.forEach((elem) => {

                const Arr = AllData.filter((item) => item.from == elem.from && item.to == elem.to);

                let total = 0;

                Arr.forEach((el) => {
                    total += parseInt(el.value);
                })

                Users.push({ user: elem.from, total: total });
                Sum.push(total);
            })

            let max = Sum[0];

            Sum.forEach((elem) => {
                max = Math.max(max, elem);
            });

            console.log(max);

            console.log(Sum);

            const User = Users.find((elem) => elem.total == max);

            console.log(User);

            document.write(User.user);

        }

      

         



        // async function App()
        // {
        //     // const res = await fetch('https://api.etherscan.io/api?module=account&action=txlistinternal&startblock=0&endblock=2702578&page=1&offset=100&sort=asc&apikey=CVP9SCG9KAKHIPEP4RG22D43JC1TIVPUIJ');
        //     // const Data = await res.json();
            
        //     // console.log(Data.result.length)

            
        //     let i = 0;

           



           

        //     // recurcyBlock();

        //     console.log(Data);
        //     // console.log(Data.result[0].blockNumber);

            
        // }

        // App();



    </script>
    
</body>
</html>